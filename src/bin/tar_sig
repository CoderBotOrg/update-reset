#!/bin/bash
# create folder backup and signature
# put in /boot to backup raspberry boot partition
#

usage() {
	echo "tar_sig BACKUP_NAME [DIR_TO_BACKUP] [DEFAULT_KEY]"
	echo "backup current dir and creates DIRNAME.tar.xz and a DIRNAME.tar.xz.sig"
	exit 0
}

[[ $1 == "-h" || $1 == "--help" ]] && usage

fail() {
	echo $1
	exit 2
}

BACKUP_DIR=${2:-.}
FILENAME=${1}.tar.xz
SIGNAME=${1}.sig
DEF_KEY=$3

do_tar(){
	tar cfJv $FILENAME $BACKUP_DIR || fail "ERROR: could not create tar archive"
}

do_sign(){
	gpg --output $SIGNAME --default-key $DEF_KEY --detach-sign $FILENAME || fail "ERROR: could not sign file"
}	

do_tar

[ -z $DEF_KEY ] || do_sign

